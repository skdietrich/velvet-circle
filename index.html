<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>VELVET ‚Äî Discreet Connections</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&family=Raleway:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg:#0a0a0f; --sf:#12121a; --sf2:#1c1c28; --bd:#2a2a3a;
      --gold:#d4a843; --goldDim:#8a7535;
      --tx:#ede9e3; --txD:#918a9e; --txM:#5e5870;
      --red:#ff4757; --green:#2ed573;
    }
    * { box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    body { margin:0; background:var(--bg); color:var(--tx); font-family:'Raleway',sans-serif; overflow-x:hidden; }
    input, textarea, select { font-family:'Raleway',sans-serif; font-size:16px; outline:none; }
    ::-webkit-scrollbar { width:4px; }
    ::-webkit-scrollbar-thumb { background:var(--bd); border-radius:4px; }

    .vc-btn { transition:all .2s; user-select:none; touch-action:manipulation; cursor:pointer; }
    .vc-btn:active { transform:scale(.96); }
    .vc-anim-in { animation:fadeIn .35s ease-out forwards; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

    .msg-bubble { max-width:75%; padding:10px 14px; border-radius:16px; font-size:14px; line-height:1.4; margin-bottom:8px; word-wrap:break-word; }
    .msg-me { align-self:flex-end; background:var(--gold); color:#000; border-bottom-right-radius:4px; }
    .msg-them { align-self:flex-start; background:var(--sf2); color:var(--tx); border:1px solid var(--bd); border-bottom-left-radius:4px; }

    .card { background:var(--sf); border:1px solid var(--bd); border-radius:12px; padding:16px; }
    .pill { font-size:11px; letter-spacing:1px; text-transform:uppercase; color:var(--txD); }
    .topbar { padding:16px; background:var(--sf); border-bottom:1px solid var(--bd); display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size:11px; padding:2px 6px; border:1px solid var(--bd); border-radius:6px; color:var(--txD); }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useRef, useState } = React;
    const { createClient } = supabase;

    // ====== CONFIG ======
    const SUPABASE_URL = "https://wtbswbokojmzmrehrajj.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_WCwKS1Du4LePjpVqPLZQzA_dsPFbDbd";
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const C = {
      bg:"#0a0a0f", sf:"#12121a", sf2:"#1c1c28", bd:"#2a2a3a",
      gold:"#d4a843", goldDim:"#8a7535",
      tx:"#ede9e3", txD:"#918a9e", txM:"#5e5870",
      red:"#ff4757", green:"#2ed573",
    };

    const DATA = {
      TYPES: ["Married Male","Married Female","Attached Male","Attached Female","Single Male","Single Female"],
      REPORT_REASONS: ["Harassment", "Scam/Solicitation", "Underage", "Coercion", "Other"]
    };

    // ====== UI helpers ======
    const Btn = ({ children, outline, onClick, full, danger, disabled }) => (
      <button
        className="vc-btn"
        disabled={disabled}
        onClick={onClick}
        style={{
          width: full ? "100%" : "auto",
          padding: "12px 18px",
          borderRadius: 10,
          border: outline ? `1px solid ${danger ? C.red : C.gold}` : "none",
          background: outline ? "transparent" : (danger ? C.red : `linear-gradient(135deg, ${C.gold}, ${C.goldDim})`),
          color: outline ? (danger ? C.red : C.gold) : "#000",
          fontWeight: 700,
          cursor: disabled ? "not-allowed" : "pointer",
          opacity: disabled ? 0.6 : 1,
          letterSpacing: 1,
          textTransform: "uppercase",
          fontSize: 12,
        }}
      >
        {children}
      </button>
    );

    const Nav = ({ view, setView }) => (
      <div style={{
        position:"fixed", bottom:0, left:0, right:0, height:65,
        background:"rgba(18,18,26,0.98)", borderTop:`1px solid ${C.bd}`,
        display:"flex", justifyContent:"space-around", alignItems:"center",
        zIndex:9000, paddingBottom:"env(safe-area-inset-bottom)"
      }}>
        <div onClick={()=>setView("home")} style={{fontSize:24, cursor:"pointer", color: view==="home"?C.gold:C.txM}}>üè†</div>
        <div onClick={()=>setView("chats")} style={{fontSize:24, cursor:"pointer", color: (view==="chats"||view==="chat")?C.gold:C.txM}}>üí¨</div>
        <div onClick={()=>setView("profile")} style={{fontSize:24, cursor:"pointer", color: view==="profile"?C.gold:C.txM}}>üë§</div>
      </div>
    );

    // ====== Privacy tool: PhotoMasker (EXIF-stripping by re-encoding) ======
    const PhotoMasker = ({ onSave, onCancel }) => {
      const [image, setImage] = useState(null);
      const [blur, setBlur] = useState(8);
      const [mask, setMask] = useState(true);
      const canvasRef = useRef(null);

      const handleFile = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => setImage(ev.target.result);
        reader.readAsDataURL(file);
      };

      const processImage = () => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext("2d");
        const img = new Image();
        img.src = image;
        img.onload = () => {
          const size = 640;
          canvas.width = size; canvas.height = size;

          // Draw blurred image (privacy by default)
          ctx.filter = `blur(${Number(blur)}px)`;
          ctx.drawImage(img, 0, 0, size, size);
          ctx.filter = "none";

          // Eye mask (simple)
          if (mask) {
            ctx.fillStyle = "rgba(0,0,0,0.95)";
            ctx.fillRect(size*0.12, size*0.33, size*0.76, size*0.14);
          }

          // Re-encode: strips EXIF metadata.
          const jpeg = canvas.toDataURL("image/jpeg", 0.82);
          onSave(jpeg);
        };
      };

      return (
        <div style={{position:"fixed", inset:0, background:"rgba(0,0,0,0.95)", zIndex:9999, display:"flex", alignItems:"center", justifyContent:"center"}}>
          <div style={{background:C.sf2, padding:18, borderRadius:14, width:"92%", maxWidth:380, border:`1px solid ${C.bd}`}}>
            <div style={{display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:10}}>
              <h3 style={{color:C.gold, margin:0, fontFamily:"Cormorant Garamond, serif", letterSpacing:1}}>Secure Photo</h3>
              <span className="pill">EXIF stripped</span>
            </div>

            {!image ? (
              <label style={{display:"block", border:`2px dashed ${C.bd}`, padding:38, borderRadius:10, marginBottom:14, cursor:"pointer", textAlign:"center"}}>
                <div style={{color:C.txM}}>Tap to Select Photo</div>
                <div style={{color:C.txD, fontSize:12, marginTop:8}}>Default: blurred + masked</div>
                <input type="file" accept="image/*" onChange={handleFile} style={{display:"none"}} />
              </label>
            ) : (
              <>
                <canvas ref={canvasRef} style={{display:"none"}} />
                <div style={{position:"relative", width:220, height:220, margin:"10px auto 14px", overflow:"hidden", borderRadius:12, border:`1px solid ${C.gold}`}}>
                  <img src={image} style={{width:"100%", height:"100%", objectFit:"cover", filter:`blur(${blur}px)`}} />
                  {mask && <div style={{position:"absolute", top:75, left:20, width:180, height:34, background:"rgba(0,0,0,0.95)", borderRadius:6}} />}
                </div>

                <div style={{marginBottom:12}}>
                  <label style={{color:C.txD, fontSize:12, display:"block", marginBottom:6}}>Blur Intensity: {blur}</label>
                  <input type="range" min="0" max="22" value={blur} onChange={e=>setBlur(e.target.value)} style={{width:"100%", accentColor:C.gold}} />
                </div>

                <div style={{display:"flex", gap:10, marginBottom:12}}>
                  <Btn outline full onClick={()=>setMask(!mask)}>{mask ? "Remove Eye Mask" : "Add Eye Mask"}</Btn>
                </div>
              </>
            )}

            <div style={{display:"flex", gap:10}}>
              <Btn outline full onClick={onCancel}>Cancel</Btn>
              <Btn full disabled={!image} onClick={processImage}>Save</Btn>
            </div>
          </div>
        </div>
      );
    };

    // ====== Core helpers ======
    function uuidLike() {
      return crypto?.randomUUID ? crypto.randomUUID() : (Math.random().toString(36).slice(2) + Date.now().toString(36));
    }

    async function ensureProfile(userId, defaults) {
      const { data: existing, error: selErr } = await sb
        .from("profiles")
        .select("*")
        .eq("id", userId)
        .maybeSingle();

      if (selErr) throw selErr;
      if (existing) return existing;

      const payload = {
        id: userId,
        username: defaults.username,
        profile_type: defaults.profile_type,
        city: defaults.city || null,
        bio: defaults.bio || null,
        is_discreet: true
      };

      const { data: inserted, error: insErr } = await sb
        .from("profiles")
        .insert(payload)
        .select("*")
        .single();

      if (insErr) throw insErr;
      return inserted;
    }

    function App() {
      const [session, setSession] = useState(null);
      const [profile, setProfile] = useState(null);

      const [view, setView] = useState("splash");

      const [authMode, setAuthMode] = useState("signin"); // signin | signup
      const [auth, setAuth] = useState({ email:"", password:"" });

      // onboarding profile fields
      const [onb, setOnb] = useState({ username:"", profile_type: DATA.TYPES[0], city:"", bio:"" });

      // browse + chats
      const [matchedProfiles, setMatchedProfiles] = useState([]);
      const [activeChat, setActiveChat] = useState(null);
      const [chatMeta, setChatMeta] = useState(null); // {chat_id, match_id, other_profile}
      const [messages, setMessages] = useState([]);
      const [msgInput, setMsgInput] = useState("");

      // safety
      const [panic, setPanic] = useState(false);
      const [showMasker, setShowMasker] = useState(false);
      const [reportOpen, setReportOpen] = useState(false);
      const [report, setReport] = useState({ reason: DATA.REPORT_REASONS[0], detail:"" });

      const scrollRef = useRef(null);

      // keyboard panic: Ctrl+Shift+P (desktop)
      useEffect(() => {
        const onKey = (e) => {
          if (e.ctrlKey && e.shiftKey && (e.key === "P" || e.key === "p")) setPanic(true);
        };
        window.addEventListener("keydown", onKey);
        return () => window.removeEventListener("keydown", onKey);
      }, []);

      // auth bootstrap
      useEffect(() => {
        sb.auth.getSession().then(({ data }) => {
          setSession(data.session || null);
        });
        const { data: sub } = sb.auth.onAuthStateChange((_evt, sess) => {
          setSession(sess || null);
        });
        return () => sub.subscription.unsubscribe();
      }, []);

      // load profile when session present
      useEffect(() => {
        (async () => {
          if (!session?.user?.id) {
            setProfile(null);
            setMatchedProfiles([]);
            setActiveChat(null);
            setChatMeta(null);
            setMessages([]);
            setView("splash");
            return;
          }

          const uid = session.user.id;
          const { data, error } = await sb.from("profiles").select("*").eq("id", uid).maybeSingle();
          if (error) {
            console.error(error);
            return;
          }
          if (data) {
            setProfile(data);
            setView("home");
          } else {
            setProfile(null);
            setView("onboarding");
          }
        })();
      }, [session]);

      // auto-scroll chat
      useEffect(() => {
        scrollRef.current?.scrollIntoView({ behavior: "smooth" });
      }, [messages, view]);

      // realtime messages subscription (per chat)
      useEffect(() => {
        if (!chatMeta?.chat_id) return;
        const channel = sb
          .channel("messages_" + chatMeta.chat_id)
          .on(
            "postgres_changes",
            { event: "INSERT", schema: "public", table: "messages", filter: `chat_id=eq.${chatMeta.chat_id}` },
            (payload) => {
              setMessages((prev) => [...prev, payload.new]);
            }
          )
          .subscribe();

        return () => { sb.removeChannel(channel); };
      }, [chatMeta?.chat_id]);

      async function signUpEmailPassword() {
        if (!auth.email || !auth.password) return alert("Email + password required.");
        const { error } = await sb.auth.signUp({ email: auth.email, password: auth.password });
        if (error) return alert(error.message);
        alert("Check your email for confirmation if required by project settings.");
      }

      async function signInEmailPassword() {
        if (!auth.email || !auth.password) return alert("Email + password required.");
        const { error } = await sb.auth.signInWithPassword({ email: auth.email, password: auth.password });
        if (error) return alert(error.message);
      }

      async function completeOnboarding() {
        if (!onb.username || onb.username.length < 3) return alert("Username (min 3 chars) required.");
        if (!onb.profile_type) return alert("Profile type required.");

        try {
          const p = await ensureProfile(session.user.id, {
            username: onb.username.trim(),
            profile_type: onb.profile_type,
            city: onb.city.trim(),
            bio: onb.bio.trim(),
          });
          setProfile(p);
          setView("home");
        } catch (e) {
          console.error(e);
          alert(e.message || "Failed to create profile.");
        }
      }

      async function loadMatches() {
        // Load match rows, then fetch other profiles.
        const uid = session.user.id;

        const { data: blocks } = await sb.from("blocks").select("blocked").eq("blocker", uid);
        const blockedSet = new Set((blocks || []).map(x => x.blocked));

        const { data: m, error } = await sb
          .from("matches")
          .select("id,a,b,status,created_at")
          .or(`a.eq.${uid},b.eq.${uid}`)
          .eq("status", "matched")
          .order("created_at", { ascending: false });

        if (error) { console.error(error); return; }
        const otherIds = (m || [])
          .map(row => (row.a === uid ? row.b : row.a))
          .filter(id => !blockedSet.has(id));

        if (otherIds.length === 0) {
          setMatchedProfiles([]);
          return;
        }

        const { data: profs, error: pErr } = await sb
          .from("profiles")
          .select("id,username,profile_type,city,bio,is_discreet,created_at")
          .in("id", otherIds);

        if (pErr) { console.error(pErr); return; }
        setMatchedProfiles(profs || []);
      }

      async function openChatWith(otherProfile) {
        const uid = session.user.id;

        // Ensure match exists (or create it) ‚Äî for demo, allow unilateral match creation.
        // Commercially, you'd implement swipe + mutual like before match is created.
        const a = uid;
        const b = otherProfile.id;

        // Upsert match
        let matchId = null;
        {
          const { data: existing } = await sb
            .from("matches")
            .select("id")
            .or(`and(a.eq.${a},b.eq.${b}),and(a.eq.${b},b.eq.${a})`)
            .maybeSingle();

          if (existing?.id) {
            matchId = existing.id;
          } else {
            const { data: created, error } = await sb
              .from("matches")
              .insert({ a, b, status: "matched" })
              .select("id")
              .single();

            if (error) return alert(error.message);
            matchId = created.id;
          }
        }

        // Ensure chat exists
        let chatId = null;
        {
          const { data: c0 } = await sb.from("chats").select("id").eq("match_id", matchId).maybeSingle();
          if (c0?.id) {
            chatId = c0.id;
          } else {
            const { data: c1, error } = await sb.from("chats").insert({ match_id: matchId }).select("id").single();
            if (error) return alert(error.message);
            chatId = c1.id;
          }
        }

        // Load messages
        const { data: msgs, error: mErr } = await sb
          .from("messages")
          .select("*")
          .eq("chat_id", chatId)
          .order("created_at", { ascending: true });

        if (mErr) { console.error(mErr); return alert(mErr.message); }

        setActiveChat(otherProfile);
        setChatMeta({ chat_id: chatId, match_id: matchId, other_profile: otherProfile });
        setMessages(msgs || []);
        setView("chat");
      }

      async function sendTextMessage() {
        if (!chatMeta?.chat_id) return;
        const body = msgInput.trim();
        if (!body) return;

        // Basic client-side spam throttle (real throttling should be server-side)
        if (body.length > 1200) return alert("Message too long.");

        const { error } = await sb.from("messages").insert({
          chat_id: chatMeta.chat_id,
          sender: session.user.id,
          body
        });

        if (error) return alert(error.message);
        setMsgInput("");
      }

      async function uploadMaskedImage(dataUrlJpeg) {
        // Convert dataURL -> Blob
        const res = await fetch(dataUrlJpeg);
        const blob = await res.blob();

        const path = `${session.user.id}/${uuidLike()}.jpg`;
        const { error: upErr } = await sb.storage.from("photos").upload(path, blob, {
          cacheControl: "3600",
          upsert: false,
          contentType: "image/jpeg"
        });
        if (upErr) throw upErr;

        return path; // private object path
      }

      async function sendImageMessage(dataUrlJpeg) {
        if (!chatMeta?.chat_id) return;
        try {
          const image_path = await uploadMaskedImage(dataUrlJpeg);
          const { error } = await sb.from("messages").insert({
            chat_id: chatMeta.chat_id,
            sender: session.user.id,
            image_path
          });
          if (error) return alert(error.message);
        } catch (e) {
          console.error(e);
          alert(e.message || "Upload failed.");
        }
      }

      async function signOut() {
        await sb.auth.signOut();
      }

      async function blockUser(otherId) {
        const { error } = await sb.from("blocks").insert({ blocker: session.user.id, blocked: otherId });
        if (error) return alert(error.message);
        alert("Blocked.");
        setView("home");
        setActiveChat(null);
        setChatMeta(null);
        setMessages([]);
        loadMatches();
      }

      async function submitReport() {
        if (!activeChat?.id) return;
        const { error } = await sb.from("reports").insert({
          reporter: session.user.id,
          reported: activeChat.id,
          reason: report.reason,
          detail: report.detail || null
        });
        if (error) return alert(error.message);
        alert("Report submitted.");
        setReportOpen(false);
        setReport({ reason: DATA.REPORT_REASONS[0], detail:"" });
      }

      // load matches when arriving home
      useEffect(() => {
        if (view === "home" && session?.user?.id) loadMatches();
      }, [view, session?.user?.id]);

      // ========== PANIC SCREEN ==========
      if (panic) {
        return (
          <div style={{minHeight:"100vh", background:"#87CEEB", fontFamily:"Arial", color:"#fff", padding:20, display:"flex", flexDirection:"column", alignItems:"center", justifyContent:"center"}}>
            <h1 style={{fontSize:80, margin:0}}>72¬∞</h1>
            <h2 style={{fontSize:24}}>Dallas, TX</h2>
            <p>Partly Cloudy</p>
            <div style={{position:"absolute", top:16, left:16, color:"#fff"}}>
              <span className="kbd">Ctrl</span> + <span className="kbd">Shift</span> + <span className="kbd">P</span> to toggle
            </div>
            <button onClick={()=>setPanic(false)} style={{position:"absolute", bottom:10, right:10, width:40, height:40, opacity:0}}></button>
          </div>
        );
      }

      // ========== SPLASH ==========
      if (view === "splash") {
        return (
          <div style={{minHeight:"100vh", display:"flex", flexDirection:"column", alignItems:"center", justifyContent:"center", background:`radial-gradient(circle at center, #1a1520 0%, ${C.bg} 100%)`}}>
            <h1 style={{fontFamily:"Cormorant Garamond, serif", fontSize:52, color:C.gold, letterSpacing:4, margin:0}}>VELVET</h1>
            <p style={{color:C.txD, letterSpacing:2, fontSize:11, marginTop:10}}>DISCREET CONNECTIONS ‚Ä¢ TRUST-FIRST</p>

            <div style={{width:"92%", maxWidth:420, marginTop:26}} className="card">
              <div style={{display:"flex", gap:10, marginBottom:12}}>
                <Btn full outline onClick={()=>setAuthMode("signin")} disabled={authMode==="signin"}>Sign In</Btn>
                <Btn full outline onClick={()=>setAuthMode("signup")} disabled={authMode==="signup"}>Join</Btn>
              </div>

              <div style={{display:"flex", flexDirection:"column", gap:10}}>
                <input
                  style={{width:"100%", background:C.sf2, border:`1px solid ${C.bd}`, padding:14, borderRadius:10, color:C.tx}}
                  placeholder="Email"
                  value={auth.email}
                  onChange={e=>setAuth({...auth, email:e.target.value})}
                  autoComplete="email"
                />
                <input
                  style={{width:"100%", background:C.sf2, border:`1px solid ${C.bd}`, padding:14, borderRadius:10, color:C.tx}}
                  type="password"
                  placeholder="Password"
                  value={auth.password}
                  onChange={e=>setAuth({...auth, password:e.target.value})}
                  autoComplete={authMode==="signup" ? "new-password" : "current-password"}
                />

                {authMode==="signup" ? (
                  <Btn full onClick={signUpEmailPassword}>Create Account</Btn>
                ) : (
                  <Btn full onClick={signInEmailPassword}>Enter Site</Btn>
                )}

                <div style={{color:C.txM, fontSize:12, marginTop:10, lineHeight:1.5}}>
                  Privacy defaults: masked images, consent-first controls, block/report.
                  <div style={{marginTop:6}}>
                    Panic exit: <span className="kbd">Ctrl</span> + <span className="kbd">Shift</span> + <span className="kbd">P</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      }

      // ========== ONBOARDING (create profile row) ==========
      if (view === "onboarding") {
        return (
          <div className="vc-anim-in" style={{minHeight:"100vh", padding:24}}>
            <div style={{display:"flex", alignItems:"center", justifyContent:"space-between"}}>
              <h2 style={{color:C.gold, fontFamily:"Cormorant Garamond, serif", margin:0}}>Profile Setup</h2>
              <Btn outline danger onClick={signOut}>Sign Out</Btn>
            </div>

            <div className="card" style={{marginTop:16}}>
              <div className="pill" style={{marginBottom:8}}>Required</div>

              <select
                style={{width:"100%", background:C.sf2, color:C.tx, border:`1px solid ${C.bd}`, padding:12, borderRadius:10, marginBottom:12}}
                value={onb.profile_type}
                onChange={e=>setOnb({...onb, profile_type:e.target.value})}
              >
                {DATA.TYPES.map(t => <option key={t} value={t}>{t}</option>)}
              </select>

              <input
                style={{width:"100%", background:C.sf2, border:`1px solid ${C.bd}`, padding:12, borderRadius:10, marginBottom:12, color:C.tx}}
                placeholder="Username (public handle)"
                value={onb.username}
                onChange={e=>setOnb({...onb, username:e.target.value})}
              />

              <div className="pill" style={{margin:"10px 0 8px"}}>Optional</div>

              <input
                style={{width:"100%", background:C.sf2, border:`1px solid ${C.bd}`, padding:12, borderRadius:10, marginBottom:12, color:C.tx}}
                placeholder="City (can be vague)"
                value={onb.city}
                onChange={e=>setOnb({...onb, city:e.target.value})}
              />

              <textarea
                style={{width:"100%", background:C.sf2, border:`1px solid ${C.bd}`, padding:12, borderRadius:10, color:C.tx, minHeight:90}}
                placeholder="Bio (keep it discreet)"
                value={onb.bio}
                onChange={e=>setOnb({...onb, bio:e.target.value})}
              />

              <div style={{marginTop:14}}>
                <Btn full onClick={completeOnboarding}>Finish</Btn>
              </div>
            </div>
          </div>
        );
      }

      // ========== HOME ==========
      if (view === "home") {
        return (
          <div className="vc-anim-in" style={{padding:"16px 16px 80px"}}>
            <div className="topbar">
              <div>
                <div style={{fontFamily:"Cormorant Garamond, serif", color:C.gold, fontSize:24, letterSpacing:1}}>Near You</div>
                <div className="pill">Matched-only browse (safer default)</div>
              </div>
              <button onClick={()=>setPanic(true)} style={{background:C.red, border:"none", borderRadius:"50%", width:34, height:34, color:"#fff", cursor:"pointer"}} title="Panic">‚ö°</button>
            </div>

            <div style={{marginTop:14}}>
              {matchedProfiles.length === 0 ? (
                <div className="card" style={{textAlign:"center", color:C.txM}}>
                  No matched profiles yet. (Commercial version: add swipe/like funnel before matches.)
                </div>
              ) : matchedProfiles.map(p => (
                <div key={p.id} onClick={()=>openChatWith(p)} className="card" style={{marginBottom:10, display:"flex", alignItems:"center", gap:12, cursor:"pointer"}}>
                  <div style={{width:52, height:52, borderRadius:"50%", background:C.sf2, border:`2px solid ${C.gold}`, display:"flex", alignItems:"center", justifyContent:"center"}}>
                    <span style={{fontWeight:800}}>{(p.username||"?").slice(0,1).toUpperCase()}</span>
                  </div>
                  <div style={{flex:1}}>
                    <div style={{fontWeight:700}}>{p.username}</div>
                    <div style={{fontSize:12, color:C.txD}}>{p.profile_type}{p.city ? ` ‚Ä¢ ${p.city}` : ""}</div>
                    {p.bio ? <div style={{fontSize:12, color:C.txM, marginTop:6, overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap"}}>{p.bio}</div> : null}
                  </div>
                </div>
              ))}
            </div>

            <Nav view={view} setView={setView} />
          </div>
        );
      }

      // ========== CHATS ==========
      if (view === "chats") {
        // Commercial: use a last-message view via SQL view or RPC. Here we simply list matched profiles.
        return (
          <div className="vc-anim-in" style={{padding:"16px 16px 80px"}}>
            <div className="topbar">
              <div>
                <div style={{fontFamily:"Cormorant Garamond, serif", color:C.gold, fontSize:24}}>Messages</div>
                <div className="pill">Persistent ‚Ä¢ RLS-protected</div>
              </div>
              <Btn outline onClick={loadMatches}>Refresh</Btn>
            </div>

            <div style={{marginTop:14}}>
              {matchedProfiles.length === 0 ? (
                <div className="card" style={{textAlign:"center", color:C.txM}}>No chats yet.</div>
              ) : matchedProfiles.map(p => (
                <div key={p.id} onClick={()=>openChatWith(p)} className="card" style={{marginBottom:10, cursor:"pointer"}}>
                  <div style={{fontWeight:700}}>{p.username}</div>
                  <div style={{fontSize:12, color:C.txD}}>{p.profile_type}{p.city ? ` ‚Ä¢ ${p.city}` : ""}</div>
                </div>
              ))}
            </div>

            <Nav view={view} setView={setView} />
          </div>
        );
      }

      // ========== CHAT ==========
      if (view === "chat" && activeChat && chatMeta) {
        return (
          <div className="vc-anim-in" style={{display:"flex", flexDirection:"column", height:"100vh"}}>
            <div style={{padding:14, background:C.sf, borderBottom:`1px solid ${C.bd}`, display:"flex", alignItems:"center", justifyContent:"space-between", gap:10}}>
              <div style={{display:"flex", alignItems:"center", gap:10}}>
                <button onClick={()=>setView("chats")} style={{background:"none", border:"none", color:C.tx, fontSize:20, cursor:"pointer"}}>‚Üê</button>
                <div>
                  <div style={{fontWeight:800}}>{activeChat.username}</div>
                  <div style={{fontSize:12, color:C.txD}}>{activeChat.profile_type}{activeChat.city ? ` ‚Ä¢ ${activeChat.city}` : ""}</div>
                </div>
              </div>

              <div style={{display:"flex", gap:8}}>
                <Btn outline danger onClick={()=>setReportOpen(true)}>Report</Btn>
                <Btn outline danger onClick={()=>blockUser(activeChat.id)}>Block</Btn>
              </div>
            </div>

            <div style={{flex:1, overflowY:"auto", padding:16, display:"flex", flexDirection:"column"}}>
              {messages.map((m) => {
                const isMe = m.sender === session.user.id;
                return (
                  <div key={m.id} className={`msg-bubble ${isMe ? "msg-me" : "msg-them"}`}>
                    {m.image_path ? (
                      <PrivateImage path={m.image_path} />
                    ) : null}
                    {m.body ? <div>{m.body}</div> : null}
                    <div style={{fontSize:10, opacity:0.6, marginTop:6}}>
                      {new Date(m.created_at).toLocaleString()}
                    </div>
                  </div>
                );
              })}
              <div ref={scrollRef}></div>
            </div>

            <div style={{padding:12, background:C.sf, borderTop:`1px solid ${C.bd}`, display:"flex", gap:10, paddingBottom:"max(12px, env(safe-area-inset-bottom))"}}>
              <button onClick={()=>setShowMasker(true)} style={{background:"none", border:"none", fontSize:20, cursor:"pointer"}} title="Send masked photo">üì∑</button>
              <input
                value={msgInput}
                onChange={e=>setMsgInput(e.target.value)}
                style={{flex:1, background:C.sf2, border:"none", borderRadius:20, padding:"10px 16px", color:C.tx}}
                placeholder="Message..."
              />
              <button onClick={sendTextMessage} style={{background:"none", border:"none", color:C.gold, fontWeight:"bold", cursor:"pointer"}}>SEND</button>
            </div>

            {showMasker && (
              <PhotoMasker
                onCancel={()=>setShowMasker(false)}
                onSave={(jpeg)=>{ setShowMasker(false); sendImageMessage(jpeg); }}
              />
            )}

            {reportOpen && (
              <div style={{position:"fixed", inset:0, background:"rgba(0,0,0,0.9)", zIndex:9999, display:"flex", alignItems:"center", justifyContent:"center"}}>
                <div className="card" style={{width:"92%", maxWidth:420}}>
                  <div style={{display:"flex", justifyContent:"space-between", alignItems:"center"}}>
                    <div style={{fontFamily:"Cormorant Garamond, serif", color:C.gold, fontSize:22}}>Report</div>
                    <Btn outline onClick={()=>setReportOpen(false)}>Close</Btn>
                  </div>
                  <div style={{marginTop:12}}>
                    <select
                      style={{width:"100%", background:C.sf2, color:C.tx, border:`1px solid ${C.bd}`, padding:12, borderRadius:10, marginBottom:12}}
                      value={report.reason}
                      onChange={e=>setReport({...report, reason:e.target.value})}
                    >
                      {DATA.REPORT_REASONS.map(r => <option key={r} value={r}>{r}</option>)}
                    </select>
                    <textarea
                      style={{width:"100%", background:C.sf2, color:C.tx, border:`1px solid ${C.bd}`, padding:12, borderRadius:10, minHeight:100}}
                      placeholder="Details (optional)"
                      value={report.detail}
                      onChange={e=>setReport({...report, detail:e.target.value})}
                    />
                    <div style={{marginTop:12}}>
                      <Btn full danger onClick={submitReport}>Submit Report</Btn>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      // ========== PROFILE ==========
      if (view === "profile") {
        return (
          <div className="vc-anim-in" style={{padding:"16px 16px 80px"}}>
            <div className="topbar">
              <div>
                <div style={{fontFamily:"Cormorant Garamond, serif", color:C.gold, fontSize:24}}>My Profile</div>
                <div className="pill">Auth-backed ‚Ä¢ RLS-protected</div>
              </div>
              <div style={{display:"flex", gap:10}}>
                <Btn outline onClick={()=>setPanic(true)}>Panic</Btn>
                <Btn outline danger onClick={signOut}>Sign Out</Btn>
              </div>
            </div>

            <div className="card" style={{marginTop:14}}>
              <div style={{fontWeight:800, fontSize:18}}>{profile?.username}</div>
              <div style={{color:C.txD, marginTop:6}}>{profile?.profile_type}{profile?.city ? ` ‚Ä¢ ${profile.city}` : ""}</div>
              {profile?.bio ? <div style={{color:C.txM, marginTop:10, lineHeight:1.5}}>{profile.bio}</div> : null}
            </div>

            <div className="card" style={{marginTop:10}}>
              <div className="pill">Edit</div>
              <div style={{display:"flex", flexDirection:"column", gap:10, marginTop:10}}>
                <input
                  style={{width:"100%", background:C.sf2, border:`1px solid ${C.bd}`, padding:12, borderRadius:10, color:C.tx}}
                  value={profile?.city || ""}
                  placeholder="City"
                  onChange={e=>setProfile({...profile, city:e.target.value})}
                />
                <textarea
                  style={{width:"100%", background:C.sf2, border:`1px solid ${C.bd}`, padding:12, borderRadius:10, color:C.tx, minHeight:90}}
                  value={profile?.bio || ""}
                  placeholder="Bio"
                  onChange={e=>setProfile({...profile, bio:e.target.value})}
                />
                <Btn full onClick={async()=>{
                  const { error } = await sb.from("profiles").update({
                    city: profile.city || null,
                    bio: profile.bio || null
                  }).eq("id", session.user.id);
                  if (error) return alert(error.message);
                  alert("Updated.");
                }}>Save</Btn>
              </div>
            </div>

            <Nav view={view} setView={setView} />
          </div>
        );
      }

      return null;
    }

    // ===== Private image component: signed URL for private bucket =====
    function PrivateImage({ path }) {
      const [url, setUrl] = useState(null);

      useEffect(() => {
        (async () => {
          const { data, error } = await sb.storage.from("photos").createSignedUrl(path, 60);
          if (error) { console.error(error); return; }
          setUrl(data.signedUrl);
        })();
      }, [path]);

      if (!url) return <div style={{fontSize:12, opacity:0.7}}>Loading image‚Ä¶</div>;
      return <img src={url} style={{maxWidth:"100%", borderRadius:10, display:"block", marginBottom:8}} />;
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<App />);
  </script>
</body>
</html>
