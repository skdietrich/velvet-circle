<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Weather - Dallas, TX</title> <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,400&family=Raleway:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg: #0a0a0f; --sf: #12121a; --sf2: #1c1c28; --bd: #2a2a3a;
            --gold: #d4a843; --goldDim: #8a7535;
            --sec: #9b59b6; --secDim: #6c3483;
            --tx: #ede9e3; --txD: #918a9e; --txM: #5e5870;
            --red: #ff4757; --green: #2ed573;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; background: var(--bg); color: var(--tx); font-family: 'Raleway', sans-serif; overflow-x: hidden; }
        input, textarea, select { font-family: 'Raleway', sans-serif; font-size: 16px; outline: none; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: var(--bd); border-radius: 4px; }
        
        /* Animation & Interaction */
        .vc-btn { transition: all 0.2s; user-select: none; touch-action: manipulation; cursor: pointer; }
        .vc-btn:active { transform: scale(0.96); }
        .vc-anim-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(10px);} to{opacity:1;transform:translateY(0);} }
        
        /* Chat Styles */
        .msg-bubble { max-width: 75%; padding: 10px 14px; border-radius: 16px; font-size: 14px; line-height: 1.4; margin-bottom: 8px; word-wrap: break-word; }
        .msg-me { align-self: flex-end; background: var(--gold); color: #000; border-bottom-right-radius: 4px; }
        .msg-them { align-self: flex-start; background: var(--sf2); color: var(--tx); border: 1px solid var(--bd); border-bottom-left-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createClient } = supabase;

        // ‚îÄ‚îÄ‚îÄ CONFIGURATION ‚îÄ‚îÄ‚îÄ
        const APP_KEY = "vc_v5_final";
        const C = {
            bg: "#0a0a0f", sf: "#12121a", sf2: "#1c1c28", bd: "#2a2a3a",
            gold: "#d4a843", goldDim: "#8a7535",
            sec: "#9b59b6", secDim: "#6c3483",
            tx: "#ede9e3", txD: "#918a9e", txM: "#5e5870",
            red: "#ff4757", green: "#2ed573",
        };

        const DATA = {
            TYPES: ["Married Male","Married Female","Attached Male","Attached Female","Single Male","Single Female"],
        };

        // ‚îÄ‚îÄ‚îÄ PHOTO MASKER COMPONENT (Privacy Tool) ‚îÄ‚îÄ‚îÄ
        const PhotoMasker = ({ onSave, onCancel }) => {
            const [image, setImage] = useState(null);
            const [blur, setBlur] = useState(0);
            const [mask, setMask] = useState(false);
            const canvasRef = useRef(null);

            const handleFile = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (ev) => setImage(ev.target.result);
                    reader.readAsDataURL(file);
                }
            };

            const processImage = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext("2d");
                const img = new Image();
                img.src = image;
                img.onload = () => {
                    // Set safe dimensions
                    canvas.width = 400; canvas.height = 400;
                    
                    // 1. Draw Blurred Image
                    ctx.filter = `blur(${blur}px)`;
                    ctx.drawImage(img, 0, 0, 400, 400);
                    ctx.filter = "none"; 

                    // 2. Draw Eye Mask
                    if (mask) {
                        ctx.fillStyle = "black";
                        ctx.fillRect(50, 130, 300, 60); 
                    }

                    // 3. Export as JPEG
                    onSave(canvas.toDataURL("image/jpeg", 0.7));
                };
            };

            return (
                <div style={{position:"fixed", inset:0, background:"rgba(0,0,0,0.95)", zIndex:9999, display:"flex", alignItems:"center", justifyContent:"center"}}>
                    <div style={{background:C.sf2, padding:20, borderRadius:12, width:"90%", maxWidth:350, textAlign:"center", border:`1px solid ${C.bd}`}}>
                        <h3 style={{color:C.gold, marginTop:0, fontFamily:"serif"}}>Secure Photo</h3>
                        {!image ? (
                            <label style={{display:"block", border:`2px dashed ${C.bd}`, padding:40, borderRadius:8, marginBottom:20, cursor:"pointer"}}>
                                <span style={{color:C.txM}}>Tap to Select</span>
                                <input type="file" accept="image/*" onChange={handleFile} style={{display:"none"}} />
                            </label>
                        ) : (
                            <>
                                <canvas ref={canvasRef} style={{display:"none"}} />
                                <div style={{position:"relative", width:200, height:200, margin:"0 auto 20px", overflow:"hidden", borderRadius:8, border:`1px solid ${C.gold}`}}>
                                    <img src={image} style={{width:"100%", height:"100%", objectFit:"cover", filter:`blur(${blur}px)`}} />
                                    {mask && <div style={{position:"absolute", top:65, left:25, width:150, height:30, background:"black"}} />}
                                </div>
                                <div style={{marginBottom:15}}>
                                    <label style={{color:C.txD, fontSize:12, display:"block", marginBottom:5}}>Blur Intensity: {blur}</label>
                                    <input type="range" min="0" max="20" value={blur} onChange={e=>setBlur(e.target.value)} style={{width:"100%", accentColor:C.gold}} />
                                </div>
                                <button onClick={()=>setMask(!mask)} style={{background:"transparent", border:`1px solid ${C.gold}`, color:C.gold, padding:"8px 16px", borderRadius:20, marginBottom:20, cursor:"pointer", fontSize:12}}>
                                    {mask ? "Remove Eye Mask" : "Add Eye Mask"}
                                </button>
                            </>
                        )}
                        <div style={{display:"flex", gap:10}}>
                            <button onClick={onCancel} style={{flex:1, padding:12, background:"transparent", color:C.txM, border:"none", cursor:"pointer"}}>Cancel</button>
                            {image && <button onClick={processImage} style={{flex:1, padding:12, background:C.gold, color:"#000", border:"none", borderRadius:8, fontWeight:"bold", cursor:"pointer"}}>Save & Send</button>}
                        </div>
                    </div>
                </div>
            );
        };

        // ‚îÄ‚îÄ‚îÄ MAIN APP LOGIC ‚îÄ‚îÄ‚îÄ
        function App() {
            // State
            const [user, setUser] = useState(null);
            const [view, setView] = useState("splash");
            const [profiles, setProfiles] = useState([]);
            const [messages, setMessages] = useState({});
            const [activeChat, setActiveChat] = useState(null);
            const [showMasker, setShowMasker] = useState(false);
            const [panic, setPanic] = useState(false);
            const [client, setClient] = useState(null);
            
            // Login/Reg State
            const [login, setLogin] = useState({ u:"", p:"" });
            const [reg, setReg] = useState({ u:"", p:"", type:"Married Male", city:"" });
            const [msgInput, setMsgInput] = useState("");
            const scrollRef = useRef(null);

            // Utils
            const hashPw = (pw) => { let h=0; for(let i=0;i<pw.length;i++){h=((h<<5)-h)+pw.charCodeAt(i);h|=0;} return "h_"+Math.abs(h).toString(36); };
            
            // Local Database (Fallback & Cache)
            const db = {
                get: (k) => { try { return JSON.parse(localStorage.getItem(APP_KEY+k)); } catch { return null; } },
                set: (k,v) => { try { localStorage.setItem(APP_KEY+k, JSON.stringify(v)); } catch {} }
            };

            // ‚îÄ‚îÄ‚îÄ INITIALIZATION ‚îÄ‚îÄ‚îÄ
            useEffect(() => {
                // 1. SUPABASE CONNECTION (Using your provided keys)
                const supaUrl = "https://wtbswbokojmzmrehrajj.supabase.co";
                const supaKey = "sb_publishable_WCwKS1Du4LePjpVqPLZQzA_dsPFbDbd";

                // Initialize Supabase Client
                const _client = createClient(supaUrl, supaKey);
                setClient(_client);

                // Fetch Profiles from DB
                _client.from('profiles').select('*').then(({ data, error }) => {
                    if (data && data.length) {
                        setProfiles(prev => {
                            // Merge DB profiles with local seeds, avoiding duplicates
                            const newProfs = data.filter(d => !prev.find(p => p.username === d.username));
                            return [...prev, ...newProfs];
                        });
                    }
                });

                // 2. Load Local State
                const u = db.get("user");
                const m = db.get("msgs") || {};
                const seeds = db.get("profs") || [];
                
                if (u) { setUser(u); setView("home"); }
                setMessages(m);
                setProfiles(p => [...p, ...seeds]); // Load cached profiles
            }, []);

            // ‚îÄ‚îÄ‚îÄ ACTIONS ‚îÄ‚îÄ‚îÄ
            
            const handleRegister = async () => {
                if(!reg.u || !reg.p) return alert("Required fields missing");
                
                const newProfile = { 
                    id: Math.random().toString(36).substr(2,9), 
                    username: reg.u, 
                    passwordHash: hashPw(reg.p), 
                    profileType: reg.type, 
                    city: reg.city, 
                    photos: [], 
                    online: true 
                };

                // Update Local State
                setUser(newProfile);
                setProfiles(prev => [...prev, newProfile]);
                db.set("user", newProfile);
                db.set("profs", [...profiles, newProfile]);

                // Sync to Supabase
                if (client) {
                    await client.from('profiles').insert([{ 
                        username: reg.u, 
                        profile_type: reg.type, 
                        city: reg.city, 
                        is_discreet: true 
                    }]);
                }
                setView("home");
            };

            const handleLogin = () => {
                const p = profiles.find(x => x.username.toLowerCase() === login.u.toLowerCase());
                if (p && p.passwordHash === hashPw(login.p)) { 
                    setUser(p); 
                    db.set("user", p); 
                    setView("home"); 
                } else { 
                    alert("Invalid credentials (or user not found locally)."); 
                }
            };

            const sendMsg = (imgUrl = null) => {
                if (!msgInput.trim() && !imgUrl) return;
                
                const chatKey = [user.id, activeChat.id || activeChat.username].sort().join("_");
                const newMsg = { from: user.id, text: msgInput, img: imgUrl, ts: Date.now() };
                
                const updatedMsgs = { ...messages, [chatKey]: [...(messages[chatKey]||[]), newMsg] };
                setMessages(updatedMsgs);
                db.set("msgs", updatedMsgs);
                setMsgInput("");
            };

            const updateUser = (newData) => {
                const updated = { ...user, ...newData };
                setUser(updated);
                db.set("user", updated);
            };

            // Auto-scroll chat
            useEffect(() => { scrollRef.current?.scrollIntoView({ behavior: "smooth" }); }, [messages, activeChat, view]);

            // ‚îÄ‚îÄ‚îÄ UI COMPONENTS ‚îÄ‚îÄ‚îÄ

            const Btn = ({ children, outline, onClick, full }) => (
                <button onClick={onClick} style={{ width: full?"100%":"auto", padding:"12px 24px", borderRadius:8, border: outline?`1px solid ${C.gold}`:"none", background: outline?"transparent":`linear-gradient(135deg, ${C.gold}, ${C.goldDim})`, color: outline?C.gold:"#000", fontWeight:600, cursor:"pointer", textTransform:"uppercase", letterSpacing:1 }}>{children}</button>
            );

            const Nav = () => (
                <div style={{position:"fixed", bottom:0, left:0, right:0, height:65, background:"rgba(18,18,26,0.98)", borderTop:`1px solid ${C.bd}`, display:"flex", justifyContent:"space-around", alignItems:"center", zIndex:9000, paddingBottom:"env(safe-area-inset-bottom)"}}>
                    <div onClick={()=>setView("home")} style={{fontSize:24, cursor:"pointer", color: view==="home"?C.gold:C.txM}}>üè†</div>
                    <div onClick={()=>setView("chats")} style={{fontSize:24, cursor:"pointer", color: (view==="chats"||view==="chat")?C.gold:C.txM}}>üí¨</div>
                    <div onClick={()=>setView("profile")} style={{fontSize:24, cursor:"pointer", color: view==="profile"?C.gold:C.txM}}>üë§</div>
                </div>
            );

            // ‚îÄ‚îÄ‚îÄ VIEWS ‚îÄ‚îÄ‚îÄ

            // 1. PANIC SCREEN (Weather App)
            if (panic) return <div style={{minHeight:"100vh", background:"#87CEEB", fontFamily:"Arial", color:"#fff", padding:20, display:"flex", flexDirection:"column", alignItems:"center", justifyContent:"center"}}><h1 style={{fontSize:80, margin:0}}>72¬∞</h1><h2 style={{fontSize:24}}>Dallas, TX</h2><p>Partly Cloudy</p><button onClick={()=>setPanic(false)} style={{position:"absolute", bottom:10, right:10, width:40, height:40, opacity:0}}></button></div>;

            // 2. SPLASH SCREEN
            if (view === "splash") return (
                <div style={{minHeight:"100vh", display:"flex", flexDirection:"column", alignItems:"center", justifyContent:"center", background:`radial-gradient(circle at center, #1a1520 0%, ${C.bg} 100%)`}}>
                    <h1 style={{fontFamily:"serif", fontSize:48, color:C.gold, letterSpacing:4, margin:0}}>VELVET</h1>
                    <p style={{color:C.txD, letterSpacing:2, fontSize:10, marginTop:10}}>DISCREET CONNECTIONS</p>
                    <div style={{display:"flex", gap:16, marginTop:40}}><Btn onClick={()=>setView("register")}>Join</Btn><Btn outline onClick={()=>setView("login")}>Log In</Btn></div>
                </div>
            );

            // 3. LOGIN SCREEN
            if (view === "login") return <div style={{minHeight:"100vh", padding:30, display:"flex", alignItems:"center", justifyContent:"center"}}><div style={{width:"100%", maxWidth:360}}><h2 style={{color:C.gold, textAlign:"center", fontFamily:"serif"}}>Sign In</h2><input style={{width:"100%", background:C.sf2, border:`1px solid ${C.bd}`, padding:14, borderRadius:8, color:C.tx, marginBottom:12}} placeholder="Username" value={login.u} onChange={e=>setLogin({...login, u:e.target.value})} /><input style={{width:"100%", background:C.sf2, border:`1px solid ${C.bd}`, padding:14, borderRadius:8, color:C.tx, marginBottom:20}} type="password" placeholder="Password" value={login.p} onChange={e=>setLogin({...login, p:e.target.value})} /><Btn full onClick={handleLogin}>Enter Site</Btn><p style={{textAlign:"center", color:C.txM, marginTop:24, cursor:"pointer"}} onClick={()=>setView("splash")}>Back</p></div></div>;

            // 4. REGISTER SCREEN
            if (view === "register") return <div style={{minHeight:"100vh", padding:30}}><h2 style={{color:C.gold, fontFamily:"serif"}}>Join</h2><select style={{width:"100%", background:C.sf2, color:C.tx, border:`1px solid ${C.bd}`, padding:12, borderRadius:8, marginBottom:16}} value={reg.type} onChange={e=>setReg({...reg, type:e.target.value})}>{DATA.TYPES.map(t=><option key={t}>{t}</option>)}</select><input style={{width:"100%", background:C.sf2, border:`1px solid ${C.bd}`, padding:12, borderRadius:8, marginBottom:12, color:C.tx}} placeholder="Username" value={reg.u} onChange={e=>setReg({...reg, u:e.target.value})} /><input style={{width:"100%", background:C.sf2, border:`1px solid ${C.bd}`, padding:12, borderRadius:8, marginBottom:12, color:C.tx}} type="password" placeholder="Password" value={reg.p} onChange={e=>setReg({...reg, p:e.target.value})} /><input style={{width:"100%", background:C.sf2, border:`1px solid ${C.bd}`, padding:12, borderRadius:8, marginBottom:20, color:C.tx}} placeholder="City" value={reg.city} onChange={e=>setReg({...reg, city:e.target.value})} /><Btn full onClick={handleRegister}>Create Account</Btn><p style={{textAlign:"center", color:C.txM, marginTop:24, cursor:"pointer"}} onClick={()=>setView("splash")}>Cancel</p></div>;

            // 5. HOME (BROWSE)
            if (view === "home") return (
                <div className="vc-anim-in" style={{padding:"20px 16px 80px"}}>
                    <div style={{display:"flex", justifyContent:"space-between", alignItems:"center", marginBottom:20}}><h2 style={{fontFamily:"serif", color:C.gold, margin:0}}>Near You</h2><button onClick={()=>setPanic(true)} style={{background:C.red, border:"none", borderRadius:"50%", width:30, height:30, color:"#fff", cursor:"pointer"}}>‚ö°</button></div>
                    {profiles.length > 0 ? profiles.filter(p=>p.username !== user.username).map(p => (
                        <div key={p.id || p.username} onClick={()=>{setActiveChat(p); setView("chat");}} style={{background:C.sf, padding:16, borderRadius:12, marginBottom:10, display:"flex", alignItems:"center", gap:12, border:`1px solid ${C.bd}`, cursor:"pointer"}}>
                            <div style={{width:50, height:50, background:C.sf2, borderRadius:"50%", overflow:"hidden", border:`2px solid ${C.gold}`}}>{p.photos && p.photos[0] ? <img src={p.photos[0]} style={{width:"100%", height:"100%", objectFit:"cover"}}/> : <div style={{width:"100%", height:"100%", display:"flex", alignItems:"center", justifyContent:"center"}}>?</div>}</div>
                            <div><div style={{fontWeight:600}}>{p.username}</div><div style={{fontSize:12, color:C.txD}}>{p.profileType} ‚Ä¢ {p.city}</div></div>
                        </div>
                    )) : <div style={{color:C.txM, textAlign:"center", marginTop:40}}>No members found yet.</div>}
                    <Nav />
                </div>
            );

            // 6. CHAT LIST
            if (view === "chats") {
                const chats = Object.keys(messages).filter(k=>k.includes(user.id)).map(k=>{ 
                    const oid = k.split("_").find(id=>id!==user.id); 
                    const p = profiles.find(pr => pr.id === oid || pr.username === oid);
                    return {id:oid, p: p || {username:"Unknown"}, last:messages[k][messages[k].length-1]}; 
                });
                return <div className="vc-anim-in" style={{padding:"20px 16px 80px"}}><h2 style={{fontFamily:"serif", color:C.gold}}>Messages</h2>{chats.map(c=><div key={c.id} onClick={()=>{setActiveChat(c.p); setView("chat");}} style={{background:C.sf, padding:16, borderRadius:12, marginBottom:10, display:"flex", gap:12, cursor:"pointer"}}><div style={{fontWeight:600}}>{c.p.username}</div><div style={{color:C.txM, overflow:"hidden", textOverflow:"ellipsis", whiteSpace:"nowrap"}}>{c.last.text || "Photo"}</div></div>)}<Nav /></div>;
            }

            // 7. ACTIVE CHAT
            if (view === "chat" && activeChat) {
                const chatKey = [user.id, activeChat.id || activeChat.username].sort().join("_");
                const msgs = messages[chatKey] || [];
                return (
                    <div className="vc-anim-in" style={{display:"flex", flexDirection:"column", height:"100vh"}}>
                        <div style={{padding:16, background:C.sf, borderBottom:`1px solid ${C.bd}`, display:"flex", alignItems:"center", gap:10}}>
                            <button onClick={()=>setView("chats")} style={{background:"none", border:"none", color:C.tx, fontSize:20, cursor:"pointer"}}>‚Üê</button>
                            <div style={{fontWeight:600}}>{activeChat.username}</div>
                        </div>
                        <div style={{flex:1, overflowY:"auto", padding:16, display:"flex", flexDirection:"column"}}>
                            {msgs.map((m,i)=>(
                                <div key={i} className={`msg-bubble ${m.from===user.id?"msg-me":"msg-them"}`}>
                                    {m.img && <img src={m.img} style={{maxWidth:"100%", borderRadius:8, marginBottom:4}} />}
                                    {m.text}
                                </div>
                            ))}
                            <div ref={scrollRef}></div>
                        </div>
                        <div style={{padding:12, background:C.sf, borderTop:`1px solid ${C.bd}`, display:"flex", gap:10, paddingBottom:"max(12px, env(safe-area-inset-bottom))"}}>
                            <button onClick={()=>setShowMasker(true)} style={{background:"none", border:"none", fontSize:20, cursor:"pointer"}}>üì∑</button>
                            <input value={msgInput} onChange={e=>setMsgInput(e.target.value)} style={{flex:1, background:C.sf2, border:"none", borderRadius:20, padding:"10px 16px", color:C.tx}} placeholder="Message..." />
                            <button onClick={()=>sendMsg()} style={{background:"none", border:"none", color:C.gold, fontWeight:"bold", cursor:"pointer"}}>SEND</button>
                        </div>
                        {showMasker && <PhotoMasker onCancel={()=>setShowMasker(false)} onSave={(img)=>{ sendMsg(img); setShowMasker(false); }} />}
                    </div>
                );
            }

            // 8. MY PROFILE
            if (view === "profile") return <div className="vc-anim-in" style={{padding:"20px 16px 80px"}}><div style={{textAlign:"center"}}><div style={{width:100, height:100, background:C.sf2, borderRadius:"50%", margin:"0 auto 15px", overflow:"hidden", border:`2px solid ${C.gold}`}}>{user.photos && user.photos[0] ? <img src={user.photos[0]} style={{width:"100%", height:"100%", objectFit:"cover"}} /> : null}</div><h3>{user.username}</h3><p style={{color:C.txD}}>{user.profileType} ‚Ä¢ {user.city}</p><div style={{marginTop:20, marginBottom:30}}><Btn full outline onClick={()=>setShowMasker(true)}>+ Add Secure Photo</Btn></div><Btn outline onClick={()=>{setUser(null); setView("splash");}}>Log Out</Btn></div><div style={{marginTop:30}}><h4 style={{color:C.txM, fontSize:12}}>PRIVATE GALLERY</h4><div style={{display:"flex", gap:10, overflowX:"auto"}}>{user.photos && user.photos.map((p,i) => (<img key={i} src={p} style={{width:70, height:70, borderRadius:8, objectFit:"cover", border:`1px solid ${C.bd}`}} />))}</div></div>{showMasker && <PhotoMasker onCancel={()=>setShowMasker(false)} onSave={(img) => { const currentPhotos = user.photos || []; updateUser({ photos: [...currentPhotos, img] }); setShowMasker(false); }} />}<Nav /></div>;

            return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
